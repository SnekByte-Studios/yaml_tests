---
name: Changes Comparison

# Trigger: PR must be opened or reopened.
on:
  pull_request:
    types: [opened, reopened]

# If trigger, do:
jobs:

  # Job #1 - Retrieve metadata and save it in env files.
  upload-artifacts:
    name: setup
    runs-on: ubuntu-latest
    steps:
      - name: Scrape HEADs
        shell: bash
        
        # Scrape repository secrets and setup environment variables.
        env:
          USERNAME: $ {{ secrets.AUTH_UNAME }}
          TOKEN: ${{ secrets.SECRET_TOKEN }}
          REPO: ${{ secrets.REPO }}
          OWNER: ${{ secrets.OWNER }}
          
        # Get open requests' and the trigger request's HEADs and save them in env files.
        run: |
          # Clear open_prs
          echo "" > open_prs.txt
          
          printf "Scraping open PR HEADs "
          # Get open PRs' HEADs
          if open_request_ids=`curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ env.TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ env.OWNER }}/${{ env.REPO }}/pulls \
            | jq -r .[].head.sha`; then
            
            # Repopulate open_prs
            for id in $open_request_ids
            do
              printf "."
              echo "${id}" >> open_prs.txt
            done
            printf "SUCCESS!\n"
            
          else
            printf "FAILED!\n"
            echo "Failed to scrape open request HEADs."
            echo "Confirm the URL is correct."
            exit 1
          fi
          
          # Get URL of the trigger PR
          pull_request_url=$(jq -r .pull_request.url "$GITHUB_EVENT_PATH")
          
          printf "Scraping trigger commit HEAD "
          # Get trigger commit HEAD
          if commit_id=$(curl -L \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ env.TOKEN }}" \
            "$pull_request_url" \
            | jq -r '.head.sha'); then
            # Overwrite most recent commit HEAD
            echo "$commit_id" > commit_id.txt
            printf "... SUCCESS!\n"
            
          else
            printf "... FAILED!\n"
            echo "Couldn't retrieve trigger PR's HEAD"
            echo "Confirm your token hasn't expired."
            exit 1
          fi

        # Upload the env files. name is ID. Must match downloads.
      - name: upload open PR commit HEADs
        uses: actions/upload-artifact@v4
        with:
          name: open_prs
          path: open_prs.txt
          
      - name: upload trigger commit HEAD
        uses: actions/upload-artifact@v4
        with:
          name: commit_id
          path: commit_id.txt

  # job #2 - Download the artifacts and use the data to compare changes between potentially divergent branches.
  download-artifacts:
    needs: upload-artifacts
    runs-on: ubuntu-latest
    
    name: Compare Changes
    steps:
        # Get the repository,
      - name: Get Repository
        uses: actions/checkout@v4
        
        # Sign in with username and email, rebase local branch and checkout to main,
        # Necessary to access the repository.
      - name: Pull Latest Changes
        shell: bash
        run: |
          git config --global user.email ${{ secrets.AUTH_EMAIL }}
          git config --global user.name ${{ secrets.AUTH_UNAME }}
          git config pull.rebase true
          git pull origin main
          git checkout main
        # Ensure this step finished successfully before continuing,
        # Else end task.
        if: ${{ success() }}
          
        # Download artifacts. Must execute after checkout.
      - name: Retrieve Open PR's
        uses: actions/download-artifact@v4
        with:
          # Must match
          name: open_prs
      - name: Retrieve Commit ID
        uses: actions/download-artifact@v4
        with:
          # Must match
          name: commit_id
          
        # Scrape repository secrets and setup environment variables.
      - shell: bash
        name: Compare Changes
        env:
          USERNAME: ${{ secrets.AUTH_UNAME }}
          TOKEN: ${{ secrets.SECRET_TOKEN }}
          REPO: ${{ secrets.REPO }}
          OWNER: ${{ secrets.OWNER }}
          WEBHOOK: "https://discord.com/api/webhooks/1223645310929211453/yemReyMJH38Qz7f1RcRYKta6SiiPjvwnNUSkB0zZouj5I3scoc3-Hs2UQbepdXrstTL7"
          PAYLOAD: '{"Content": "testme pretty please"}'
        
        # Iterate through open PR commits and compare changes between
        # The trigger commit and other PR commits.
        run: |
          # Update repository after downloading artifacts
          git pull
          
          if [ -e "open_prs.txt" ] && [ -e "commit_id.txt" ]; then
            
            # Iterate through open PR commit HEADs
            while IFS= read -r line; do
              # First line is empty. If empty, continue
              if [ -z "$line" ]; then
                continue
              else
                git rebase $line || { curl -H "Content-Type: application/json"\
                -X POST -d ${{ env.PAYLOAD }} ${{ env.WEBHOOK }}; exit 1; }
              fi
            done < open_prs.txt
          else
            echo "No open_prs.txt or commit_id.txt in directory"
            exit 1
          fi
...
